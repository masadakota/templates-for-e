<!DOCTYPE >
<html lang="ja">
  <head>
    <title>後処理テンプレ</title>
    <style>
      .container {
        padding: 1rem;
      }
      body {
        font-family: sans-serif;
        padding: 20px;
      }
      /* アニメーション用 */
      .copy-flash-transition {
        transition: background-color 0.75s ease;
      }
      .info {
        color: #666;
        margin-bottom: 20px;
      }
      /* ラベルのテキスト選択を無効化 */
      label {
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 style="font-size: 1.5rem">後処理テンプレ</h1>

        <div style="display: flex; gap: 1rem; flex-wrap: wrap">
          <label>
            <input
              type="checkbox"
              class="check-item"
              data-target="status-urgent"
            />
            至急対応希望
          </label>

          <label>
            <input
              type="checkbox"
              class="check-item"
              data-target="status-note"
            />
            備考要確認
          </label>
        </div>

      <div
        style="
          border: 1px solid #ccc;
          padding: 10px;
          border-radius: 8px;
          width: fit-content;
        "
      >
        <div style="display: flex; gap: 1rem; flex-wrap: wrap">
          <label>
            <input
              type="checkbox"
              id="status-checkbox"
              class="status-checkbox"
            />
            案内済
          </label>
        </div>

        <div
          style="
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 8px;
            width: fit-content;
            margin-top: 10px;
            margin-bottom: 10px;
          "
        >
        <div>
          <label>
            <input
            type="radio"
            name="paid"
            value="有償警告"
            checked
            class="paid-radio"
            />
            有償警告
          </label>

          <label>
            <input
            type="radio"
            name="paid"
            value="メーカー保証期間内の有償警告"
            class="paid-radio"
            />
            メーカー保証期間内の有償警告
          </label>

          <label>
            <input
            type="radio"
            name="paid"
            value="保証対象外部位有償案内"
            class="paid-radio"
            />
            保証対象外部位有償案内
          </label>
          </div>
          <label style="display: block;">
            <input type="checkbox" id="paid-status-checkbox" />
            案内済
          </label>
        </div>

        <div
          style="
            gap: 1rem;
            flex-wrap: wrap;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 8px;
            /* width: fit-content; */
            margin-top: 10px;
            margin-bottom: 10px;
          "
        >
          <div style="
            display: flex;
            gap: 1rem;
          ">
            <label>
              <input
              type="checkbox"
              class="check-item"
              data-target="status-delay"
              />
              <span id="status-delay-label"></span>
            </label>
            
            <label id="maker-checkbox-container">
              <input type="checkbox" id="maker-checkbox" class="maker-checkbox" />
              三菱
            </label>
            <label>
              <input
              type="checkbox"
              id="newyear-checkbox"
              class="newyear-checkbox"
              />
              年末年始トーク
            </label>
          </div>
          <label style="display: block;">
            <input type="checkbox" id="delay-status-checkbox" />
            案内済
          </label>
        </div>
      </div>
      
      <div
        style="
          display: flex;
          gap: 1rem;
          align-items: center;
          flex-wrap: wrap;
          border: 1px solid #ccc;
          padding: 10px;
          border-radius: 8px;
          width: fit-content;
          margin-top: 10px;
        "
      >
        <label>
          <input type="checkbox" class="check-item" data-target="status-name" />
          名前の聴取
        </label>

        <label>
          <select id="person-select">
            <option value="奥様">奥様</option>
            <option value="ご主人様">ご主人様</option>
            <option value="ご子息様">ご子息様</option>
            <option value="ご息女様">ご息女様</option>
            <option value="お母様">お母様</option>
            <option value="お父様">お父様</option>
            <option value="折り返しTEL先の方">折り返しTEL先の方</option>
          </select>
        </label>
      </div>

      <div
        style="display: flex; gap: 1rem; align-items: center; margin-top: 10px"
      >
        <button
          id="update-datetime-btn"
          style="padding: 5px 10px; cursor: pointer"
        >
          日時を更新
        </button>

        <label>
          オペレーター名:
          <input
            type="text"
            id="name-input"
            style="padding: 5px; width: 100px"
          />
        </label>
      </div>

      <div
        id="results"
        class="copyable"
        style="
          border: 3px solid #aaa;
          max-width: 400px;
          border-radius: 8px;
          white-space: pre-wrap;
          padding: 0.5rem;
          margin-top: 1rem;
          /* margin-bottom: 1rem; */
        "
      >
        <span id="current-datetime"></span><span>CC</span
        ><span id="name-display"></span><br /><span id="status-urgent"></span
        ><span id="status-note"></span><span id="status-name-prefix"></span><span id="person-name"></span><span id="status-name-suffix"></span
        ><span id="status-paid"></span
        ><span id="status-display-paid" class="status-display"></span
        ><br /><span id="status-delay"></span
        ><span id="status-display-delay" class="status-display"></span><br />
      </div>
      <div style="color: #888; font-size: 0.9rem">↑右クリックでコピー</div>

      <div class="my-table">
        <div class="cop">Hello</div>
        <div>Good Bye</div>
        <div class="copyable">Test</div>
      </div>
    </div>

    <script>
      let statusUrgentText = "【至急対応希望】\n";
      let statusNoteText = "備考要確認\n";
      let statusNameText = "奥様の名前の聴取をお願いします。\n";
      let statusPaidText = "有償警告";
      let statusDelayText = "お日にちがかかる案内";

      // 入力のデフォルト値（ここで変更すると HTML の初期状態に依存せず設定できます）
      const DEFAULTS = {
        status: "未",
        maker: "三菱以外",
        paid: "有償警告",
        checks: {
          "status-urgent": false,
          "status-note": false,
          "status-name": false,
          "status-delay": true,
        },
      };

      // targetId に対応する最新の表示文字列を返す
      function getTextFor(targetId) {
        switch (targetId) {
          case "status-urgent":
            return statusUrgentText;
          case "status-note":
            return "・" + statusNoteText;
          case "status-name":
            return "・" + statusNameText;
          case "status-delay":
            return "・" + statusDelayText;
          default:
            return "";
        }
      }

      const statusCheckbox = document.getElementById("status-checkbox");
      const paidStatusCheckbox = document.getElementById("paid-status-checkbox");
      const delayStatusCheckbox = document.getElementById("delay-status-checkbox");
      const makerCheckbox = document.getElementById("maker-checkbox");
      const newyearCheckbox = document.getElementById("newyear-checkbox");
      const paidRadios = document.querySelectorAll(".paid-radio");
      const personSelect = document.getElementById("person-select");
      const updateDatetimeBtn = document.getElementById("update-datetime-btn");
      const nameInput = document.getElementById("name-input");

      // 名前入力フィールドの変更を監視
      if (nameInput) {
        nameInput.addEventListener("input", () => {
          updateNameDisplay();
        });
      }

      // 名前表示を更新する関数
      function updateNameDisplay() {
        const nameValue = nameInput.value.trim();
        const nameDisplayElement = document.getElementById("name-display");
        if (nameDisplayElement) {
          nameDisplayElement.textContent = nameValue;
        }
      }

      // 日時更新ボタンのクリックイベント
      if (updateDatetimeBtn) {
        updateDatetimeBtn.addEventListener("click", () => {
          displayCurrentDateTime();
        });
      }

      // 呼称selectの変更を監視
      if (personSelect) {
        personSelect.addEventListener("change", () => {
          const selectedPerson = personSelect.value;
          statusNameText = selectedPerson + "の名前の聴取をお願いします。\n";

          // person-name要素のみを更新（flashElementはMutationObserverが自動的に実行）
          const personNameElement = document.getElementById("person-name");
          if (personNameElement) {
            personNameElement.textContent = selectedPerson;
          }
        });
      }

      // status-checkboxの状態を子チェックボックスの状態に基づいて更新する関数
      function updateStatusCheckboxState() {
        if (!statusCheckbox || !paidStatusCheckbox || !delayStatusCheckbox) {
          return;
        }

        const paidChecked = paidStatusCheckbox.checked;
        const delayChecked = delayStatusCheckbox.checked;

        if (paidChecked && delayChecked) {
          // 両方チェックされている場合
          statusCheckbox.checked = true;
          statusCheckbox.indeterminate = false;
        } else if (!paidChecked && !delayChecked) {
          // 両方チェックされていない場合
          statusCheckbox.checked = false;
          statusCheckbox.indeterminate = false;
        } else {
          // 混在している場合（不確定状態）
          statusCheckbox.checked = false;
          statusCheckbox.indeterminate = true;
        }

        updateStatusDisplay();
      }

      // ステータスチェックボックスの変更を監視
      if (statusCheckbox) {
        statusCheckbox.addEventListener("change", () => {
          // indeterminateの場合は、クリックでcheckedに変更
          if (statusCheckbox.indeterminate) {
            statusCheckbox.indeterminate = false;
            statusCheckbox.checked = true;
          }

          const isChecked = statusCheckbox.checked;

          // 105行目と142行目のチェックボックスを連動させる
          if (paidStatusCheckbox) {
            paidStatusCheckbox.checked = isChecked;
          }
          if (delayStatusCheckbox) {
            delayStatusCheckbox.checked = isChecked;
          }

          updateStatusDisplay();
        });
      }

      // paid-status-checkboxの変更を監視
      if (paidStatusCheckbox) {
        paidStatusCheckbox.addEventListener("change", () => {
          updateStatusCheckboxState();
          updateStatusDisplay();
        });
      }

      // delay-status-checkboxの変更を監視
      if (delayStatusCheckbox) {
        delayStatusCheckbox.addEventListener("change", () => {
          updateStatusCheckboxState();
          updateStatusDisplay();
        });
      }

      // メーカーチェックボックスの変更を監視
      if (makerCheckbox) {
        makerCheckbox.addEventListener("change", () => {
          console.log("maker checkbox changed");
          // 年末年始トークがチェックされている場合は何もしない
          if (newyearCheckbox && newyearCheckbox.checked) {
            return;
          }
          // チェックされていれば「三菱」、そうでなければ「三菱以外」
          const isMitsubishi = makerCheckbox.checked;
          if (isMitsubishi) {
            // 三菱の場合の文言
            statusDelayText = "通常よりお日にちがかかる案内";
          } else {
            // 三菱以外の場合の文言
            statusDelayText = "お日にちがかかる案内";
          }
          // 表示を再描画
          updateDisplays();
        });
      }

      // 年末年始トークチェックボックスの変更を監視
      if (newyearCheckbox) {
        newyearCheckbox.addEventListener("change", () => {
          console.log("newyear checkbox changed");
          const makerCheckboxContainer = document.getElementById(
            "maker-checkbox-container"
          );

          if (newyearCheckbox.checked) {
            // チェックされている場合は「年末年始トーク」に変更
            statusDelayText = "年末年始トーク";
            // 三菱チェックボックスを非表示
            if (makerCheckboxContainer) {
              makerCheckboxContainer.style.display = "none";
            }
          } else {
            // チェックが外れた場合は、メーカーチェックボックスの状態に応じて元に戻す
            const isMitsubishi = makerCheckbox && makerCheckbox.checked;
            if (isMitsubishi) {
              statusDelayText = "通常よりお日にちがかかる案内";
            } else {
              statusDelayText = "お日にちがかかる案内";
            }
            // 三菱チェックボックスを表示
            if (makerCheckboxContainer) {
              makerCheckboxContainer.style.display = "";
            }
          }
          // 表示を再描画
          updateDisplays();
        });
      }

      // 有償警告ラジオボタンの変更を監視
      paidRadios.forEach((radio) => {
        radio.addEventListener("change", () => {
          updatePaidDisplay();
        });
      });

      // すべての checkbox を取得
      const checkboxes = document.querySelectorAll(".check-item");

      // 有償警告表示を更新する関数
      function updatePaidDisplay() {
        const selectedPaid = document.querySelector(
          '.paid-radio[name="paid"]:checked'
        )?.value;
        const statusPaidElement = document.getElementById("status-paid");

        if (statusPaidElement && selectedPaid) {
          statusPaidElement.textContent = "・" + selectedPaid;
          // statusPaidElement.textContent = "・" + selectedPaid + "\n";
        }

        // status-display要素の表示制御も更新
        updateStatusDisplay();
      }

      // ステータス表示を更新する関数
      function updateStatusDisplay() {
        // チェックボックスがチェックされていれば「済」、そうでなければ「未」
        const selectedStatus =
          statusCheckbox && statusCheckbox.checked ? "済" : "未";

        // #status-value を更新（結果表示エリア用、改行付き）
        const statusDisplay = document.getElementById("status-value");
        if (statusDisplay) {
          statusDisplay.textContent = selectedStatus + "\n";
        }

        // #status-display-paid の表示を paid-status-checkbox の値に基づいて更新
        const statusDisplayPaidElement = document.getElementById(
          "status-display-paid"
        );
        if (statusDisplayPaidElement) {
          const paidStatus =
            paidStatusCheckbox && paidStatusCheckbox.checked ? "済" : "未";
          statusDisplayPaidElement.textContent = paidStatus;
        }

        // #status-display-delay の表示を delay-status-checkbox の値に基づいて更新
        const statusDisplayDelayElement = document.getElementById(
          "status-display-delay"
        );
        if (statusDisplayDelayElement) {
          const delayStatus =
            delayStatusCheckbox && delayStatusCheckbox.checked ? "済" : "未";
          statusDisplayDelayElement.textContent = delayStatus;
        }

        // #status-paid の表示状態に応じて #status-display-paid の表示を制御
        const statusPaidElement = document.getElementById("status-paid");
        if (statusPaidElement && statusDisplayPaidElement) {
          const isPaidVisible = statusPaidElement.textContent.trim() !== "";
          statusDisplayPaidElement.style.display = isPaidVisible ? "" : "none";
        }

        // #status-delay の表示状態に応じて #status-display-delay の表示を制御
        const statusDelayElement = document.getElementById("status-delay");
        if (statusDelayElement && statusDisplayDelayElement) {
          const isDelayVisible = statusDelayElement.textContent.trim() !== "";
          statusDisplayDelayElement.style.display = isDelayVisible
            ? ""
            : "none";
        }
      }

      // 定数から input の初期値を適用する（DOM がある位置にスクリプトがあるため安全）
      function applyDefaults() {
        // ステータスチェックボックス（"済"ならtrue、"未"ならfalse）
        if (statusCheckbox) {
          statusCheckbox.checked = DEFAULTS.status === "済";
        }

        // メーカーチェックボックス（"三菱"ならtrue、"三菱以外"ならfalse）
        if (makerCheckbox) {
          makerCheckbox.checked = DEFAULTS.maker === "三菱";
        }

        // 有償警告ラジオボタン
        paidRadios.forEach((r) => {
          r.checked = r.value === DEFAULTS.paid;
        });

        // チェックボックス
        checkboxes.forEach((cb) => {
          const key = cb.dataset.target;
          cb.checked = !!DEFAULTS.checks[key];
        });

        // maker によって statusDelayText を決める
        const isMitsubishi = makerCheckbox && makerCheckbox.checked;
        if (isMitsubishi) {
          statusDelayText = "通常よりお日にちがかかる案内";
        } else {
          statusDelayText = "お日にちがかかる案内";
        }

        // 補助ラベルの初期表示も更新
        const delayLabel = document.getElementById("status-delay-label");
        if (delayLabel) {
          delayLabel.textContent = "お日にちがかかる案内";
        }

        // 有償警告表示を初期化
        updatePaidDisplay();

        // ステータス表示を初期化
        updateStatusDisplay();
      }

      // 現在の日時を表示する関数
      function displayCurrentDateTime() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const day = String(now.getDate()).padStart(2, "0");
        const hours = String(now.getHours()).padStart(2, "0");
        const minutes = String(now.getMinutes()).padStart(2, "0");

        const formattedDateTime = `${year}/${month}/${day} ${hours}:${minutes} `;

        const datetimeElement = document.getElementById("current-datetime");
        if (datetimeElement) {
          datetimeElement.textContent = formattedDateTime;
        }
      }

      // デフォルト値を適用
      applyDefaults();

      // 日時を表示
      displayCurrentDateTime();

      // status-name専用の表示更新関数
      function updateStatusNameDisplay(isChecked) {
        const prefixElement = document.getElementById("status-name-prefix");
        const personNameElement = document.getElementById("person-name");
        const suffixElement = document.getElementById("status-name-suffix");

        if (isChecked) {
          // チェックされている場合：3つの要素に分けて表示
          if (prefixElement) prefixElement.textContent = "・";
          if (personNameElement) personNameElement.textContent = personSelect.value;
          if (suffixElement) suffixElement.textContent = "の名前の聴取をお願いします。\n";
        } else {
          // チェックされていない場合：すべて空に
          if (prefixElement) prefixElement.textContent = "";
          if (personNameElement) personNameElement.textContent = "";
          if (suffixElement) suffixElement.textContent = "";
        }
      }

      // 全表示を現在の状態で更新する
      function updateDisplays() {
        console.log("updateDisplays called");
        checkboxes.forEach((cb) => {
          // status-name の場合は専用関数を使用
          if (cb.dataset.target === "status-name") {
            updateStatusNameDisplay(cb.checked);
          } else {
            const display = document.getElementById(cb.dataset.target);
            display.textContent = cb.checked ? getTextFor(cb.dataset.target) : "";
          }
        });

        // checkbox ラベル等、常に表示したい補助ラベルを更新
        const delayLabel = document.getElementById("status-delay-label");
        if (delayLabel) {
          // ラベルは常に「お日にちがかかる案内」を表示
          delayLabel.textContent = "お日にちがかかる案内";
        }

        // status-display要素の表示制御も更新
        updateStatusDisplay();
      }

      // 各 checkbox の change ハンドラを登録（個別更新でも OK）
      checkboxes.forEach((cb) => {
        cb.addEventListener("change", () => {
          // status-name の場合は専用関数を使用
          if (cb.dataset.target === "status-name") {
            updateStatusNameDisplay(cb.checked);
          } else {
            const display = document.getElementById(cb.dataset.target);
            display.textContent = cb.checked ? getTextFor(cb.dataset.target) : "";
          }

          // status-display要素の表示制御も更新
          updateStatusDisplay();
        });
      });

      // 初期描画
      updateDisplays();

      // 要素ごとの元の背景色とタイマーを保持するWeakMap
      const elementFlashData = new WeakMap();

      // 指定した要素の背景色を0.5秒間変更する関数
      function flashElement(element, color = '#ffeb3b', duration = 500) {
        if (!element) return;

        // 既存のフラッシュデータを取得または初期化
        let flashData = elementFlashData.get(element);

        if (!flashData) {
          // 初回: 元の背景色を保存
          flashData = {
            originalBackground: element.style.backgroundColor || '',
            timerId: null
          };
          elementFlashData.set(element, flashData);
        }

        // 既存のタイマーがあればクリア
        if (flashData.timerId) {
          clearTimeout(flashData.timerId);
        }

        // 背景色を変更
        element.style.backgroundColor = color;

        // 新しいタイマーを設定
        flashData.timerId = setTimeout(() => {
          element.style.backgroundColor = flashData.originalBackground;
          flashData.timerId = null;
        }, duration);
      }

      // id="results" 内の要素のテキスト変更を監視
      const resultsElement = document.getElementById('results');
      if (resultsElement) {
        // 各要素の以前のテキストを保存
        const previousTextMap = new Map();

        // results内のすべてのspan要素の初期テキストを保存
        resultsElement.querySelectorAll('span').forEach(span => {
          previousTextMap.set(span, span.textContent || '');
        });

        // MutationObserverを使って子要素の変更を監視
        const observer = new MutationObserver((mutations) => {
          // 変更されたspan要素を収集（重複を避ける）
          const changedElements = new Set();

          mutations.forEach((mutation) => {
            let targetElement = null;

            // characterDataの変更（テキストノードの内容変更）
            if (mutation.type === 'characterData') {
              targetElement = mutation.target.parentElement;
            }
            // childListの変更（textContentによる直接設定）
            else if (mutation.type === 'childList') {
              targetElement = mutation.target;
            }

            // span要素の場合のみ処理
            if (targetElement &&
                targetElement.tagName === 'SPAN' &&
                resultsElement.contains(targetElement)) {

              const currentText = targetElement.textContent || '';
              const previousText = previousTextMap.get(targetElement) || '';

              // 実際にテキストが変更された場合のみフラッシュ
              if (currentText !== previousText) {
                changedElements.add(targetElement);
                previousTextMap.set(targetElement, currentText);
              }
            }
          });

          // 変更された要素をフラッシュ
          changedElements.forEach(element => {
            flashElement(element);
          });
        });

        // 監視を開始
        observer.observe(resultsElement, {
          childList: true,
          subtree: true,
          characterData: true,
          characterDataOldValue: true
        });
      }
    </script>
    <script src="copy-handler.js"></script>
  </body>
</html>
